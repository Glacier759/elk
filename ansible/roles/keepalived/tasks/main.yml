---
- name: set var
  set_fact:
    keepalived_version: 2.0.16

- name: download src
  get_url:
    url: https://www.keepalived.org/software/keepalived-{{ keepalived_version }}.tar.gz
    dest: files/tmp/keepalived-{{ keepalived_version }}.tgz
  delegate_to: localhost

- name: transfer
  unarchive:
    src: files/tmp/keepalived-{{ keepalived_version }}.tgz
    dest: /tmp

- name: install build tools
  apt:
    name: ["curl", "gcc", "libssl-dev", "libnl-3-dev", "libnl-genl-3-dev", "libsnmp-dev"]

- name: install Keepalived
  shell: |
    cd /tmp/keepalived-{{ keepalived_version }}
    ./configure --prefix=/opt/keepalived/{{ keepalived_version }}
    make
    make install

- name: create symbolic link - {{ role_name }}
  file:
    src: /opt/keepalived/{{ keepalived_version }}
    dest: "/opt/keepalived/current"
    state: link

- name: copy conf files
  copy:
    src: roles/{{ role_name }}/files/{{ item }}/
    dest: /{{ item }}
    owner: root
    group: root
    mode: u=rw,go=r
  with_items:
    - etc/logrotate.d
    - etc/rsyslog.d
    - etc/systemd/system
