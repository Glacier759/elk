---
- name: set variables
  set_fact:
    ls_home: /usr/share/logstash

- name: set up confd templates
  include_role:
    name: utils
    tasks_from: setup-confd
  vars:
    parentRole: logstash

- name: install tools
  apt:
    name: ['openjdk-8-jre']
    state: present
    update_cache: no

- name: install service
  include_role:
    name: utils
    tasks_from: install-pkg
  vars:
    version: "{{ elk_version }}"
    parentRole: logstash
  loop:
    - pkgUrl: "https://artifacts.elastic.co/downloads/logstash/logstash-oss-{{ version }}.tar.gz"
      svcHome: "{{ ls_home }}"
  loop_control:
    loop_var: opts

- name: Install plugins
  include_tasks: install-plugin.yml
  loop:
    - name: logstash-filter-uuid
      version: 3.0.5
    - name: logstash-input-couchdb_changes
      version: 3.1.6
    - name: logstash-input-irc
      version: 3.0.7
    - name: logstash-input-log4j
      version: 3.1.3
    - name: logstash-input-lumberjack
      version: 3.1.6
    - name: logstash-input-xmpp
      version: 3.1.7
    - name: logstash-output-irc
      version: 3.0.6
    - name: logstash-output-statsd
      version: 3.2.0
    - name: logstash-output-xmpp
      version: 3.0.8
  loop_control:
    loop_var: opts

- name: work around file permissions for end user
  file:
    path: "{{ ls_home }}/{{ item }}"
    owner: logstash
    group: ubuntu
    mode: 0664
  loop:
    - Gemfile
    - Gemfile.lock

- name: work around dir permissions for end user
  file:
    path: "{{ ls_home }}/{{ item }}"
    owner: logstash
    group: ubuntu
    recurse: yes
  loop:
    - vendor

- name: copy configuration files
  include_role:
    name: utils
    tasks_from: copy-conf
  vars:
    parentRole: logstash

- name: add logstash bin dir to system-wide path
  copy:
    dest: /etc/profile.d/logstash-path.sh
    content: 'PATH=$PATH:{{ ls_home }}/bin'

- name: create sbin under LS home
  file:
    path: "{{ ls_home }}/sbin"
    owner: logstash
    group: ubuntu
    state: directory

- name: add logstash sbin scripts
  copy:
    dest: "{{ ls_home }}/sbin/restart.sh"
    mode: 0755
    owner: logstash
    group: ubuntu
    content: |
      #!/usr/bin/env bash
      systemctl restart logstash

- name: set up password
  include_role:
    name: utils
    tasks_from: setup-pwd
  vars:
    password: "{{ endUserPwd }}"
